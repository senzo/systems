<h1>Listing views</h1>

<table>
  <tr>
    <th>Name</th>
    <th></th>
    <th></th>
    <th></th>
  </tr>

<% @views.each do |view| %>
  <tr>
    <td><%= view.name %></td>
    <td><%= link_to 'Show', view %></td>
    <td><%= link_to 'Edit', edit_view_path(view) %></td>
    <td><%= link_to 'Destroy', view, :confirm => 'Are you sure?', :method => :delete %></td>
  </tr>
<% end %>
</table>

<br />

<%= link_to 'New View', new_view_path %>

<script type="text/javascript">

window.onload = function () {

    var dragger = function () {
          this.ox = this.type == "rect" ? this.attr("x") : this.attr("cx");
          this.oy = this.type == "rect" ? this.attr("y") : this.attr("cy");
	  oxs.splice(0,oxs.length);
          oys.splice(0,oys.length);
	  for(i=0; i<shapes.length; i++){
	    {
            oxs.push(texte[i].attr('x'));
            oys.push(texte[i].attr('y')); 
	    } 	    
	  }
        },

        move = function (dx, dy) {
          var att = this.type == "rect" ? {x: this.ox + dx, y: this.oy + dy} : {cx: this.ox + dx, cy: this.oy + dy};
          this.attr(att);

          for(i=0; i<shapes.length; i++){
            if(i == (this.attr("id")-1)){
              texte[i].attr({x: oxs[i] + dx, y: oys[i] + dy});
            }
          }
          for (var i = connections.length; i--; ) {
            r.connection(connections[i]);
          }
        },

        up = function () {
	  if (this.type == "rect") {
  	    new Ajax.Request('/systems/' + this.attr("id"), {method: 'put', 
   	    parameters:{'system[x]': this.attr("x"), 'system[y]': this.attr("y"), id:this.attr("id")} 
	    })
	  } else { 
	    new Ajax.Request('/systems/' + this.attr("id"), {method: 'put', 
	    parameters:{'system[x]': this.attr("cx"), 'system[y]': this.attr("cy"), id:this.attr("id")}	
	    })
	  }
	},

        r = Raphael("paper", 1200, 1200),
	bord = r.rect(0,0,1200,1200).attr("stroke-width","3"),
        connections = [],
 	shapes = [],
	texte = [],
	oxs=[],
	oys=[];

	<% @systems.each do |system| %>
	var ShowSys = function() {window.open('systems/' + <%= system.id %>)}

	switch("<%= system.form %>") {
	  case "log":
	    shapes.push(
	      r.rect(<%= system.x %>, <%= system.y %>, '<%= system.length %>', <%= system.width %>, 2)
	        .attr({
	          id:<%= system.id %>,
	          fill: "<%= system.color %>",
    	          cursor: "move"
	        })
	        .toBack()
	    );
	    texte.push(r.text(<%= system.x %> +50, <%= system.y %> +10,"<%= system.name %>"));
	  break;
	  case "srv":
	    shapes.push(
              r.rect(<%= system.x %>, <%= system.y %>, 30, 30, 2)
	      .attr({
	        id: <%= system.id %>, 
	        fill: "<%= system.color %>",
	        cursor: "move"
	      })
	      .dblclick(ShowSys)
	    );	    
	    texte.push(r.text(<%= system.x %> + 15, <%= system.y %> + 38,"<%= system.name %>"));
	  break;
	  case "net":
	    shapes.push(r.circle(<%= system.x %>, <%= system.y %>,15)
	      .attr({
	        id: <%= system.id %>,
  	        fill: "<%= system.color %>",
	        cursor: "move"
	      })
	      .dblclick(ShowSys)
	    );
	    texte.push(r.text(<%= system.x %> , <%= system.y %> + 22,"<%= system.name %>"));
	  break;
	  default : 
	    shapes.push(
	      r.circle(<%= system.x %>, <%= system.y %>,15)
	        .attr({
	        id: <%= system.id %>,
	        fill: "<%= system.color %>",
	        cursor: "move"
	        })
	      .dblclick(ShowSys)
	    );
	    texte.push(r.text(<%= system.x %>, <%= system.y %> + 22,'<%= system.name %>'));
	}
	<% end %>

        for (var i = 0, ii = shapes.length; i < ii; i++) {
	  shapes[i].drag(move, dragger, up);
        }

        <% @links.each do |link| %>
	switch("<%= link.predicate %>") {
	  case "contient":
	  break;
	  default : 
            connections.push(r.connection(shapes[<%= link.linker %>], shapes[<%= link.linked %>], "#000"));
	}
        <% end %>
};

</script> 

<div id="paper"></div>

